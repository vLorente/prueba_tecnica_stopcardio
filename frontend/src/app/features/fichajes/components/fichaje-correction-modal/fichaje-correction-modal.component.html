<div class="modal-overlay" [class.active]="isOpen()" (click)="onClose()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Solicitar Corrección de Fichaje</h2>
      <button
        type="button"
        class="close-button"
        (click)="onClose()"
        [disabled]="isSubmitting()"
        aria-label="Cerrar modal"
      >
        ×
      </button>
    </div>

    <div class="modal-body">
      <!-- Datos originales -->
      <div class="original-data">
        <h3>Datos Actuales</h3>
        <div class="data-row">
          <span class="label">Entrada:</span>
          <span class="value">
            {{ originalCheckIn() | date: 'dd/MM/yyyy HH:mm' }}
          </span>
        </div>
        @if (originalCheckOut()) {
          <div class="data-row">
            <span class="label">Salida:</span>
            <span class="value">
              {{ originalCheckOut() | date: 'dd/MM/yyyy HH:mm' }}
            </span>
          </div>
        } @else {
          <div class="data-row">
            <span class="label">Salida:</span>
            <span class="value no-data">Sin registrar</span>
          </div>
        }
      </div>

      <!-- Formulario -->
      <form [formGroup]="correctionForm" (ngSubmit)="onSubmit()">
        <div class="form-section">
          <h3>Datos Corregidos</h3>

          <!-- Entrada -->
          <div class="form-group">
            <label for="checkInDate">Fecha de Entrada *</label>
            <input
              type="date"
              id="checkInDate"
              formControlName="checkInDate"
              class="form-control"
              [class.invalid]="
                correctionForm.controls.checkInDate.invalid &&
                correctionForm.controls.checkInDate.touched
              "
            />
          </div>

          <div class="form-group">
            <label for="checkInTime">Hora de Entrada *</label>
            <input
              type="time"
              id="checkInTime"
              formControlName="checkInTime"
              class="form-control"
              [class.invalid]="
                correctionForm.controls.checkInTime.invalid &&
                correctionForm.controls.checkInTime.touched
              "
            />
          </div>

          <!-- Salida -->
          <div class="form-group">
            <label for="checkOutDate">Fecha de Salida</label>
            <input
              type="date"
              id="checkOutDate"
              formControlName="checkOutDate"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label for="checkOutTime">Hora de Salida</label>
            <input
              type="time"
              id="checkOutTime"
              formControlName="checkOutTime"
              class="form-control"
            />
          </div>

          <!-- Motivo -->
          <div class="form-group">
            <label for="correctionReason">Motivo de la Corrección *</label>
            <textarea
              id="correctionReason"
              formControlName="correctionReason"
              class="form-control"
              rows="4"
              placeholder="Explica el motivo de la corrección (mínimo 10 caracteres)"
              [class.invalid]="
                correctionForm.controls.correctionReason.invalid &&
                correctionForm.controls.correctionReason.touched
              "
            ></textarea>
            <small class="char-counter">
              {{ correctionForm.controls.correctionReason.value.length }} / 1000
            </small>
            @if (
              correctionForm.controls.correctionReason.invalid &&
              correctionForm.controls.correctionReason.touched
            ) {
              <div class="error-message">
                @if (correctionForm.controls.correctionReason.errors?.['required']) {
                  El motivo es obligatorio
                }
                @if (correctionForm.controls.correctionReason.errors?.['minlength']) {
                  El motivo debe tener al menos 10 caracteres
                }
                @if (correctionForm.controls.correctionReason.errors?.['maxlength']) {
                  El motivo no puede exceder los 1000 caracteres
                }
              </div>
            }
          </div>
        </div>

        <!-- Mensaje de error -->
        @if (errorMessage()) {
          <div class="alert alert-error">
            {{ errorMessage() }}
          </div>
        }

        <!-- Acciones -->
        <div class="modal-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="onClose()"
            [disabled]="isSubmitting()"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="!canSubmit()"
          >
            @if (isSubmitting()) {
              <span class="spinner"></span>
              Enviando...
            } @else {
              Solicitar Corrección
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
