<div class="fichajes-container">
  <!-- Error Message -->
  @if (error(); as errorMsg) {
    <div class="alert alert-error">
      <span>{{ errorMsg }}</span>
      <button (click)="onCloseError()" class="btn-close" aria-label="Cerrar">√ó</button>
    </div>
  }

  <!-- Registro de Fichaje -->
  <div class="fichaje-register-section">
    <h2>Registrar Fichaje</h2>

    <!-- Fichaje Activo -->
    @if (fichajeActivo(); as activo) {
      <div class="fichaje-activo-card">
        <div class="activo-info">
          <span class="activo-label">Fichaje en curso</span>
          <div class="activo-time">
            <span class="time-label">Entrada:</span>
            <span class="time-value">{{ activo.checkIn | date: 'HH:mm' }}</span>
          </div>
          <div class="activo-elapsed">
            <span>Tiempo transcurrido: <strong>{{ getElapsedTime(activo.checkIn) }}</strong></span>
          </div>
        </div>
        <button
          (click)="onCheckOut()"
          [disabled]="processingCheckOut() || loading()"
          class="btn btn-checkout">
          @if (processingCheckOut()) {
            <span class="spinner"></span>
          }
          Registrar Salida
        </button>
      </div>
    } @else {
      <div class="fichaje-buttons">
        <button
          (click)="onCheckIn()"
          [disabled]="processingCheckIn() || loading()"
          class="btn btn-checkin">
          @if (processingCheckIn()) {
            <span class="spinner"></span>
          }
          Registrar Entrada
        </button>
        <p class="btn-help-text">
          Registra tu hora de entrada al comenzar la jornada laboral
        </p>
      </div>
    }
  </div>

  <!-- Historial de Fichajes -->
  <div class="fichajes-history-section">
    <div class="history-header">
      <h2>Historial de Fichajes</h2>
      <div class="history-stats">
        <span class="stat-item">
          <strong>{{ total() }}</strong> fichajes
        </span>
        <span class="stat-item">
          <strong>{{ totalHours().toFixed(2) }}h</strong> totales
        </span>
      </div>
    </div>

    <!-- Filter by Status -->
    <div class="filter-section">
      <label for="statusFilter" class="filter-label">Filtrar por estado:</label>
      <select
        id="statusFilter"
        [(ngModel)]="statusFilter"
        (ngModelChange)="onFilterChange($event)"
        class="filter-select">
        <option value="all">Todos</option>
        <option value="valid">V√°lidos</option>
        <option value="pending_correction">Correcci√≥n pendiente</option>
        <option value="corrected">Corregidos</option>
        <option value="rejected">Rechazados</option>
      </select>
      <span class="filter-count">{{ filteredFichajes().length }} resultados</span>
    </div>

    <!-- Loading State -->
    @if (loading() && filteredFichajes().length === 0) {
      <div class="loading-state">
        <div class="spinner-large"></div>
        <p>Cargando historial...</p>
      </div>
    }

    <!-- Empty State -->
    @if (!loading() && filteredFichajes().length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üìã</div>
        <h3>No hay fichajes registrados</h3>
        <p>Comienza registrando tu primera entrada</p>
      </div>
    }

    <!-- Fichajes Table -->
    @if (filteredFichajes().length > 0) {
      <div class="fichajes-table-container">
        <table class="fichajes-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Entrada</th>
              <th>Salida</th>
              <th>Horas</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (fichaje of filteredFichajes(); track fichaje.id) {
              <tr>
                <td>
                  <span class="date-cell">
                    {{ fichaje.checkIn | date: 'dd/MM/yyyy' }}
                  </span>
                </td>
                <td>
                  <span class="time-cell">{{ fichaje.checkIn | date: 'HH:mm' }}</span>
                </td>
                <td>
                  <span class="time-cell">
                    {{ fichaje.checkOut ? (fichaje.checkOut | date: 'HH:mm') : '--' }}
                  </span>
                </td>
                <td>
                  <span class="hours-cell">{{ formatHours(fichaje.hoursWorked) }}</span>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(fichaje)">
                    {{ getStatusText(fichaje) }}
                  </span>
                  @if (fichaje.correctionReason) {
                    <div class="correction-info">
                      <small>{{ fichaje.correctionReason }}</small>
                    </div>
                  }
                  @if (fichaje.approvalNotes) {
                    <div class="approval-notes">
                      <small><strong>RRHH:</strong> {{ fichaje.approvalNotes }}</small>
                    </div>
                  }
                </td>
                <td class="actions-cell">
                  @if (canRequestCorrection(fichaje)) {
                    <button
                      (click)="onRequestCorrection(fichaje)"
                      class="btn-icon btn-correction-icon"
                      title="Solicitar correcci√≥n"
                      aria-label="Solicitar correcci√≥n">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                      <span class="tooltip">Solicitar correcci√≥n</span>
                    </button>
                  } @else {
                    <span class="no-action">--</span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <button
          (click)="onPreviousPage()"
          [disabled]="!hasPrevPage() || loading()"
          class="btn btn-pagination">
          ‚Üê Anterior
        </button>

        <span class="pagination-info">
          P√°gina {{ currentPage() }} de {{ totalPages() }}
        </span>

        <button
          (click)="onNextPage()"
          [disabled]="!hasNextPage() || loading()"
          class="btn btn-pagination">
          Siguiente ‚Üí
        </button>
      </div>
    }
  </div>

  <!-- Modal de Correcci√≥n -->
  @if (selectedFichaje()) {
    <app-fichaje-correction-modal
      [fichaje]="selectedFichaje()!"
      [isOpen]="isModalOpen()"
      (close)="onCloseModal()"
      (submit)="onSubmitCorrection($event)"
    />
  }
</div>
