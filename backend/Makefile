.PHONY: help install dev test lint format clean migration migrate shell check all status

# Variables
PYTHON := uv run python
FASTAPI := uv run fastapi
PYTEST := uv run pytest
RUFF := uv run ruff
BLACK := uv run black
ALEMBIC := uv run alembic

help: ## Mostrar ayuda
	@echo "Comandos disponibles:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Instalar dependencias con uv
	@echo "ğŸ“¦ Instalando dependencias..."
	./scripts/start_enviroment.sh

dev: ## Ejecutar servidor de desarrollo
	@echo "ğŸš€ Iniciando servidor de desarrollo..."
	@echo "ğŸ“ Usando: fastapi dev (con auto-reload)"
	$(FASTAPI) dev app/main.py --host 0.0.0.0 --port 8000

test: ## Ejecutar tests
	@echo "ğŸ§ª Ejecutando tests..."
	$(PYTEST) -v

test-cov: ## Ejecutar tests con cobertura
	@echo "ğŸ§ª Ejecutando tests con cobertura..."
	$(PYTEST) --cov=app --cov-report=html --cov-report=term

lint: ## Ejecutar linting
	@echo "ğŸ” Ejecutando linting..."
	$(RUFF) check .

lint-fix: ## Ejecutar linting y arreglar automÃ¡ticamente
	@echo "ğŸ”§ Ejecutando linting con auto-fix..."
	$(RUFF) check . --fix

format: ## Formatear cÃ³digo con black
	@echo "âœ¨ Formateando cÃ³digo..."
	$(BLACK) .

format-check: ## Verificar formato sin modificar
	@echo "âœ¨ Verificando formato..."
	$(BLACK) . --check

migration: ## Crear nueva migraciÃ³n (usar: make migration MESSAGE="nombre" o make migration -m "nombre")
	@if [ -n "$(MESSAGE)" ]; then \
		echo "ğŸ“ Creando migraciÃ³n: $(MESSAGE)"; \
		$(ALEMBIC) revision --autogenerate -m "$(MESSAGE)"; \
	elif [ -n "$(m)" ]; then \
		echo "ğŸ“ Creando migraciÃ³n: $(m)"; \
		$(ALEMBIC) revision --autogenerate -m "$(m)"; \
	else \
		read -p "Nombre de la migraciÃ³n: " name; \
		echo "ğŸ“ Creando migraciÃ³n: $$name"; \
		$(ALEMBIC) revision --autogenerate -m "$$name"; \
	fi

migrate: ## Aplicar migraciones
	@echo "â¬†ï¸  Aplicando migraciones..."
	$(ALEMBIC) upgrade head

migrate-down: ## Revertir Ãºltima migraciÃ³n
	@echo "â¬‡ï¸  Revirtiendo migraciÃ³n..."
	$(ALEMBIC) downgrade -1

seed: ## Ejecutar seed de datos (con confirmaciÃ³n)
	@echo "ğŸŒ± Ejecutando seed..."
	$(PYTHON) scripts/seed_data.py

seed-clear: ## Ejecutar seed limpiando datos existentes (sin confirmaciÃ³n)
	@echo "ğŸŒ± Ejecutando seed (limpiando datos)..."
	$(PYTHON) scripts/seed_data.py --clear

seed-no-clear: ## Ejecutar seed sin limpiar datos existentes
	@echo "ğŸŒ± Ejecutando seed (sin limpiar)..."
	$(PYTHON) scripts/seed_data.py --no-clear

clean: ## Limpiar archivos temporales
	@echo "ğŸ§¹ Limpiando archivos temporales..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	rm -f hr_dev.db
	@echo "âœ… Limpieza completada"

status: ## Verificar estado del entorno
	@echo "ï¿½ Verificando estado del entorno..."
	./scripts/check_environment.sh

shell: ## Abrir shell de Python con contexto de la app
	@echo "ğŸš Abriendo shell..."
	$(PYTHON) -i -c "from app.database import *; from app.models import *"

check: lint format-check test ## Ejecutar todas las verificaciones

all: install migrate dev ## Instalar, migrar y ejecutar

init_dev: ## Inicializar entorno de desarrollo (instalar, migrar, seed y ejecutar)
	@echo "ğŸš€ Inicializando entorno de desarrollo..."
	$(MAKE) install
	$(MAKE) migrate
	$(MAKE) seed-clear
	$(MAKE) dev

.DEFAULT_GOAL := help
